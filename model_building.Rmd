---
title: "Model Building"
author: "Emmett Greenberg, Ted Banken, Ethan McIntosh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

This script will be where we build & validate our models of ridership.

## Read in and join the data

```{r}
get_dataset <- function(dataset) {
  read.csv(paste0('data/cleaned/stations_routes_', dataset, '.csv'))
}

xfer_station_names <- c('Park Street', 'Downtown Crossing', 'Government Center', 'State')

get_model_data <- function(season) {
  get_dataset(season) %>%
  inner_join(get_dataset(paste(season, 'geog_vars', sep='_')), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset(paste(season, 'bus&CR_connections', sep='_')), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset(paste(season, 'headways', sep='_')), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset(paste(season, 'travel_times_to_cbd', sep='_')), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset(paste(season, 'pnr_spaces', sep='_')), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset(paste(season, 'walk_scores', sep='_')), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset('acs2022_5yr_avgMedianIncome'), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset('acs2022_5yr_pop'), by=c('route_id', 'parent_station')) %>%
  inner_join(get_dataset('2021_wac_agg'), by=c('route_id', 'parent_station')) %>%
  left_join(get_dataset(paste(season, 'ridership', sep='_')), by=c('route_id', 'parent_station')) %>%
  mutate(
    transfer = case_when(stop_name %in% xfer_station_names ~ 1, .default=0),
    devl_mix = tot_jobs/(tot_pop + tot_jobs),
    avg_median_inc_1000s = avg_median_inc/1000,
    .keep='unused'
    ) %>%
  mutate(route=1, route_id_temp = route_id) %>% # this creates dummy variables for each route
  pivot_wider(names_from='route_id_temp', values_from='route', values_fill=0)
}

model_data_f23 <- get_model_data('f23')
model_data_f19 <- get_model_data('f19')
```

## Descriptive Statistics

```{r}
continuous_vars <- c('avg_boardings', 'avg_headway', 'avg_tt', 'walk_score', 'km_from_cbd', 
                     'avg_median_inc_1000s', 'ppsqft', 'jobspersqft', 'devl_mix')
sparse_vars <- c('connecting_bus_routes', 'connecting_bus_riders', 'connecting_cr_routes', 'pnr_spaces')
dummy_vars <- c('Red', 'Orange', 'Green', 'Blue', 'transfer', 'in_bos')


numeric_data <- model_data_f23 %>% select(c(continuous_vars, sparse_vars))
summary(numeric_data) # minimum, median, mean, maximum, and interquartile range for each variable
```

For dummy variables (0 or 1), show what number and percent of observations do the 1's represent
```{r}
model_data_f23 %>% summarise(across(all_of(dummy_vars), list(num = sum, pct = mean)))
```

Histograms of continuous variables
```{r}
continuous_vars %>% 
  lapply(function(var) hist(
    model_data_f23[[var]], breaks='Sturges', 
    main=paste('Histogram of', var), xlab=paste('Value of', var)
    )) %>% invisible()
```

Histograms of non-zero values for sparse variables (variables with mostly 0s)
```{r}
sparse_vars %>%
  lapply(function(var) hist(
    model_data_f23[[var]] %>% {.[. != 0]}, breaks='Sturges', 
    main=paste('Histogram of', var), xlab=paste('Value of', var)
    )) %>% invisible()
```

## Model Building

```{r}
basic_reg <- function(model) {
  lm(avg_boardings ~ walk_score + pnr_spaces + connecting_cr_routes
     + connecting_bus_riders + avg_headway + avg_tt + transfer # + sd_tt
     + Red + Orange + Blue + km_from_cbd
     + avg_median_inc_1000s #+ tot_jobs + tot_pop 
     + ppsqft + jobspersqft #+ devl_mix
     , data=model)
}

reg_f23 <- model_data_f23 %>% 
  # filter(in_bos == 1) %>% # uncomment this to do Boston-only model
  basic_reg() %>% summary()

reg_f19 <- model_data_f19 %>% 
  # filter(in_bos == 1) %>% # uncomment this to do Boston-only model
  basic_reg() %>% summary()

reg_f19$coefficients %>% cbind(reg_f23$coefficients) %>% round(2)
reg_f19$adj.r.squared %>% cbind(reg_f23$adj.r.squared)
```

```{r}
plot_y_yhat_w_labels <- function(x, y, xy_prefix) {
  plot(x=x, y=y,
       xlab=paste(xy_prefix, 'Actual Boardings'),
       ylab=paste(xy_prefix, 'Predicted Boardings'),
       main=paste(xy_prefix, 'Predicted vs. Actual Boardings by Route-Station'))
  abline(a=0, b=1) # draw 1=1 line for reference
  
  # option to add text indicating which stations are over- or under-predicted
  text(x=x, y=y, adj=c(0.5,1), cex=0.5,
       labels=paste0(
         str_sub(model$route_id, end=1), 
         '-', str_sub(model$stop_name, end=3))
       )
}

plot_y_yhat_w_labels(model$avg_boardings, predict(basic_reg), '')
plot_y_yhat_w_labels(log(model$avg_boardings), log(predict(basic_reg)), 'Logged')
```

# TODO: take a preferred specification and do cross-validation 

